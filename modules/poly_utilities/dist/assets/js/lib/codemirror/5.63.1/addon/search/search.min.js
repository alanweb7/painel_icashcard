var e;e=function(i){"use strict";function o(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null}function p(i){return i.state.search||(i.state.search=new o)}function t(i){return"string"==typeof i&&i==i.toLowerCase()}function d(i,s,c){return i.getSearchCursor(s,c,{caseFold:t(s),multiline:!0})}function m(i,s,c,l,u){i.openDialog?i.openDialog(s,u,{value:l,selectValueOnOpen:!0,bottom:i.options.search.bottom}):u(prompt(c,l))}function y(i){return i.replace(/\\([nrt\\])/g,(function(i,s){return"n"==s?"\n":"r"==s?"\r":"t"==s?"\t":"\\"==s?"\\":i}))}function a(i){var s=i.match(/^\/(.*)\/([a-z]*)$/);if(s)try{i=new RegExp(s[1],-1==s[2].indexOf("i")?"":"i")}catch(i){}else i=y(i);return("string"==typeof i?""==i:i.test(""))?/x^/:i}function h(i,s,c){var l;s.queryText=c,s.query=a(c),i.removeOverlay(s.overlay,t(s.query)),s.overlay=(l=s.query,c=t(s.query),"string"==typeof l?l=new RegExp(l.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),c?"gi":"g"):l.global||(l=new RegExp(l.source,l.ignoreCase?"gi":"g")),{token:function(i){l.lastIndex=i.pos;var s=l.exec(i.string);if(s&&s.index==i.pos)return i.pos+=s[0].length||1,"searching";s?i.pos=s.index:i.skipToEnd()}}),i.addOverlay(s.overlay),i.showMatchesOnScrollbar&&(s.annotate&&(s.annotate.clear(),s.annotate=null),s.annotate=i.showMatchesOnScrollbar(s.query,t(s.query)))}function r(s,c,l,u){var f,b,N,w,O,M,S=p(s);if(S.query)return g(s,c);(M=s.getSelection()||S.lastQuery)instanceof RegExp&&"x^"==M.source&&(M=null),l&&s.openDialog?(f=null,b=function(c,l){i.e_stop(l),c&&(c!=S.queryText&&(h(s,S,c),S.posFrom=S.posTo=s.getCursor()),f&&(f.style.opacity=1),g(s,l.shiftKey,(function(i,c){var l;c.line<3&&document.querySelector&&(l=s.display.wrapper.querySelector(".CodeMirror-dialog"))&&l.getBoundingClientRect().bottom-4>s.cursorCoords(c,"window").top&&((f=l).style.opacity=.4)})))},w=C(N=s),O=M,l=function(c,l){var u=i.keyName(c),f=s.getOption("extraKeys"),u;"findNext"==(u=f&&f[u]||i.keyMap[s.getOption("keyMap")][u])||"findPrev"==u||"findPersistentNext"==u||"findPersistentPrev"==u?(i.e_stop(c),h(s,p(s),l),s.execCommand(u)):"find"!=u&&"findPersistent"!=u||(i.e_stop(c),b(l,c))},N.openDialog(w,b,{value:O,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){v(N)},onKeyDown:l,bottom:N.options.search.bottom}),u&&M&&(h(s,S,M),g(s,c))):m(s,C(s),"Search for:",M,(function(i){i&&!S.query&&s.operation((function(){h(s,S,i),S.posFrom=S.posTo=s.getCursor(),g(s,c)}))}))}function g(s,c,l){s.operation((function(){var u=p(s),f=d(s,u.query,c?u.posFrom:u.posTo);(f.find(c)||(f=d(s,u.query,c?i.Pos(s.lastLine()):i.Pos(s.firstLine(),0))).find(c))&&(s.setSelection(f.from(),f.to()),s.scrollIntoView({from:f.from(),to:f.to()},20),u.posFrom=f.from(),u.posTo=f.to(),l&&l(f.from(),f.to()))}))}function v(i){i.operation((function(){var s=p(i);s.lastQuery=s.query,s.query&&(s.query=s.queryText=null,i.removeOverlay(s.overlay),s.annotate&&(s.annotate.clear(),s.annotate=null))}))}function x(i,s){var c,l,u,f=i?document.createElement(i):document.createDocumentFragment();for(c in s)f[c]=s[c];for(l=2;l<arguments.length;l++)u=arguments[l],f.appendChild("string"==typeof u?document.createTextNode(u):u);return f}function C(i){return x("",null,x("span",{className:"CodeMirror-search-label"},i.phrase("Search:"))," ",x("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})," ",x("span",{style:"color: #888",className:"CodeMirror-search-hint"},i.phrase("(Use /re/ syntax for regexp search)")))}function q(i,s,c){i.operation((function(){for(var l,u=d(i,s);u.findNext();)"string"!=typeof s?(l=i.getRange(u.from(),u.to()).match(s),u.replace(c.replace(/\$(\d)/g,(function(i,s){return l[s]})))):u.replace(c)}))}function n(i,s){var c,l,u;i.getOption("readOnly")||(c=i.getSelection()||p(i).lastQuery,u=x("",null,x("span",{className:"CodeMirror-search-label"},l=s?i.phrase("Replace all:"):i.phrase("Replace:")),(u=i,x("",null," ",x("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})," ",x("span",{style:"color: #888",className:"CodeMirror-search-hint"},u.phrase("(Use /re/ syntax for regexp search)"))))),m(i,u,l,c,(function(c){c&&(c=a(c),m(i,x("",null,x("span",{className:"CodeMirror-search-label"},i.phrase("With:"))," ",x("input",{type:"text",style:"width: 10em",className:"CodeMirror-search-field"})),i.phrase("Replace with:"),"",(function(l){var u,f,b;l=y(l),s?q(i,c,l):(v(i),u=d(i,c,i.getCursor("from")),f=function(){var s,N,w,O,M=u.from();!(s=u.findNext())&&(u=d(i,c),!(s=u.findNext())||M&&u.from().line==M.line&&u.from().ch==M.ch)||(i.setSelection(u.from(),u.to()),i.scrollIntoView({from:u.from(),to:u.to()}),w=x("",null,x("span",{className:"CodeMirror-search-label"},(O=N=i).phrase("Replace?"))," ",x("button",{},O.phrase("Yes"))," ",x("button",{},O.phrase("No"))," ",x("button",{},O.phrase("All"))," ",x("button",{},O.phrase("Stop"))),M=i.phrase("Replace?"),O=[function(){b(s)},f,function(){q(i,c,l)}],N.openConfirm?N.openConfirm(w,O):confirm(M)&&O[0]())},b=function(i){u.replace("string"==typeof c?l:l.replace(/\$(\d)/g,(function(s,c){return i[c]}))),f()},f())})))})))}i.defineOption("search",{bottom:!1}),i.commands.find=function(i){v(i),r(i)},i.commands.findPersistent=function(i){v(i),r(i,!1,!0)},i.commands.findPersistentNext=function(i){r(i,!1,!0,!0)},i.commands.findPersistentPrev=function(i){r(i,!0,!0,!0)},i.commands.findNext=r,i.commands.findPrev=function(i){r(i,!0)},i.commands.clearSearch=v,i.commands.replace=n,i.commands.replaceAll=function(i){n(i,!0)}},"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror);